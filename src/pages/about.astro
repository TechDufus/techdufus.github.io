---
import BaseLayout from '../layouts/BaseLayout.astro';
import {
  aboutCopy,
  aboutHowIOperate,
  aboutNow,
  featuredRepos,
  profileSpotlight,
  siteMetadata
} from '../data/site';
import { getGitHubStarsByRepoUrl } from '../lib/github';

const formatStars = (count: number) => new Intl.NumberFormat('en-US').format(count);

const featuredReposWithStars = await Promise.all(
  featuredRepos.map(async (repo) => {
    const stars = await getGitHubStarsByRepoUrl(repo.url);
    return { ...repo, stars };
  })
);
---

<BaseLayout title="About" description={aboutCopy.intro}>
  <section class="hero-surface hero-grid-lines reveal reveal-delay-1">
    <div class="grid gap-6 lg:grid-cols-[0.85fr_1.15fr] lg:items-center">
      <figure class="profile-frame gentle-float mx-auto w-full max-w-[18rem] sm:max-w-sm lg:mx-0">
        <img
          src={profileSpotlight.photo}
          alt={profileSpotlight.photoAlt}
          class="profile-photo"
          width={profileSpotlight.photoWidth}
          height={profileSpotlight.photoHeight}
          loading="eager"
          decoding="async"
          fetchpriority="high"
        />
        <figcaption class="border-t border-white/10 px-4 py-3 font-mono text-xs uppercase tracking-[0.12em] text-zinc-300">
          {siteMetadata.role}
        </figcaption>
      </figure>

      <div>
        <p class="eyebrow">About</p>
        <h1 class="hero-title">{profileSpotlight.introTitle}</h1>
        <p class="mt-2 font-mono text-sm text-signal">{profileSpotlight.nickname}</p>
        <p class="mt-4 max-w-3xl text-zinc-200 sm:text-lg">{aboutCopy.intro}</p>
        <p class="mt-3 max-w-2xl text-zinc-300">{profileSpotlight.intro}</p>
        <p class="mt-4 status-pill">
          <span class="status-dot" aria-hidden="true"></span>
          {profileSpotlight.status}
        </p>

        <div class="mt-6 flex flex-wrap gap-2">
          <a class="nav-link nav-link-active" href="#featured-repos">See Featured Repos</a>
          <a class="nav-link" href="/contact">Reach Out</a>
          <a class="nav-link" href="/blog">Read Blog</a>
        </div>
      </div>
    </div>
  </section>

  <section class="content-section grid gap-3 lg:grid-cols-[1.05fr_0.95fr] lg:items-start reveal reveal-delay-2">
    <article class="panel compact-panel p-5">
      <div class="section-head">
        <h2>The Backstory (Short Version)</h2>
        <p>I found PowerShell, caught the automation bug, and realized I could make a career out of being lazy in the best way: automate it.</p>
      </div>
      <div class="grid gap-3">
        {aboutCopy.body.map((paragraph) => (
          <p class="m-0 max-w-4xl leading-relaxed text-zinc-300" set:html={paragraph}></p>
        ))}
      </div>
    </article>

    <aside class="panel compact-panel p-5">
      <div class="section-head">
        <h2>Current Focus</h2>
        <p>{aboutNow.timeframe}</p>
      </div>
      <p class="m-0 text-sm leading-relaxed text-zinc-200">{aboutNow.primaryFocus}</p>
      <ul class="m-0 mt-3 grid gap-2 list-none p-0">
        {aboutNow.activeTracks.map((track) => (
          <li class="rounded-lg border border-line/90 bg-[#0c1017] px-3 py-2.5 text-sm text-zinc-300">
            <p class="m-0 font-mono text-[11px] uppercase tracking-[0.12em] text-signal">{track.title}</p>
            <p class="m-0 mt-1.5">{track.detail}</p>
          </li>
        ))}
      </ul>
    </aside>
  </section>

  <section class="content-section panel compact-panel p-5 reveal reveal-delay-3">
    <div class="section-head">
      <h2>How I Operate</h2>
      <p>{aboutHowIOperate.intro}</p>
    </div>
    <div class="grid gap-2 sm:grid-cols-2">
      {aboutHowIOperate.items.map((item) => (
        <article class="story-card">
          <p class="m-0 font-mono text-[11px] uppercase tracking-[0.12em] text-signal">{item.title}</p>
          <p class="m-0 mt-1.5 text-sm leading-relaxed text-zinc-200">{item.detail}</p>
        </article>
      ))}
    </div>
  </section>

  <section id="featured-repos" class="content-section reveal reveal-delay-4">
    <div class="section-head">
      <h2>Featured GitHub Repos</h2>
      <p>The projects I keep open during real work.</p>
    </div>

    <div class="repo-rail">
      {featuredReposWithStars.map((repo) => (
        <article class="repo-rail-card interactive-card compact-panel p-4">
          <a
            href={repo.url}
            class="card-link-overlay"
            target="_blank"
            rel="noopener noreferrer"
            aria-label={`Open ${repo.name} repository`}
          ></a>
          <div class="card-content">
            <div class="flex items-center justify-between gap-3">
              <p class="m-0 font-mono text-[11px] uppercase tracking-[0.12em] text-signal">{repo.tag}</p>
              <div class="flex items-center gap-1.5">
                <span class="rounded-full border border-amber-300/30 bg-amber-300/10 px-2 py-1 font-mono text-[10px] uppercase tracking-[0.1em] text-amber-100">
                  {`â˜… ${repo.stars !== null ? formatStars(repo.stars) : repo.starsFallback ?? 'n/a'}`}
                </span>
                <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 font-mono text-[10px] uppercase tracking-[0.1em] text-zinc-200">
                  {repo.status}
                </span>
              </div>
            </div>
            <h3 class="m-0 mt-2.5 text-lg font-semibold text-zinc-100">{repo.name}</h3>
            <p class="m-0 mt-1.5 text-sm leading-relaxed text-zinc-300">{repo.summary}</p>
            <p class="m-0 mt-2.5 text-xs text-muted">Why I keep it around: {repo.whyItMatters}</p>
          </div>
        </article>
      ))}
    </div>
  </section>

  <a
    class="content-section panel compact-panel mx-auto w-full max-w-3xl p-6 reveal reveal-delay-5 interactive-card card-link-block no-underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-signal focus-visible:ring-offset-2 focus-visible:ring-offset-canvas"
    href="/contact"
  >
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="space-y-1">
        <h2 class="m-0 text-3xl font-semibold tracking-tight text-zinc-100">Say Hey!</h2>
        <p class="m-0 text-zinc-200">Seriously, please talk to me.</p>
      </div>
      <span class="link-chip inline-flex">Open Contact Page -></span>
    </div>
  </a>
</BaseLayout>
