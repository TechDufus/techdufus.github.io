---
const loopSteps = [
  {
    cmd: 'git pull origin main',
    output: ['Already up to date.']
  },
  {
    cmd: 'kubectl get pods -n platform',
    output: ['api-gateway 1/1 Running', 'worker 2/2 Running', 'metrics-sidecar 1/1 Running']
  },
  {
    cmd: 'npm run build',
    output: ['Build complete. 31 pages generated.']
  },
  {
    cmd: 'gh issue list --label incident',
    output: ['#214 dns drift fixed', '#219 rollback doc added']
  }
];
---

<section class="terminal-lab panel" data-loop-steps={JSON.stringify(loopSteps)}>
  <div class="terminal-lab-head">
    <div class="terminal-lights" aria-hidden="true">
      <span class="terminal-light terminal-light-red"></span>
      <span class="terminal-light terminal-light-yellow"></span>
      <span class="terminal-light terminal-light-green"></span>
    </div>
    <p class="m-0 font-mono text-[11px] uppercase tracking-[0.12em] text-zinc-300">live terminal</p>
  </div>

  <div class="terminal-lab-body">
    <p class="terminal-note m-0">Looping local session view</p>
    <div class="terminal-log mt-3" data-terminal-log aria-live="polite"></div>
  </div>
</section>

<script is:inline>
  (() => {
    const root = document.currentScript?.previousElementSibling;
    if (!(root instanceof HTMLElement)) return;

    const log = root.querySelector('[data-terminal-log]');
    if (!(log instanceof HTMLElement)) return;

    const loopStepsRaw = root.getAttribute('data-loop-steps');
    if (!loopStepsRaw) return;

    let steps;
    try {
      steps = JSON.parse(loopStepsRaw);
    } catch {
      return;
    }

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const prompt = 'techdufus@lab';
    const sleep = (ms) => new Promise((resolve) => window.setTimeout(resolve, ms));

    const addLine = (text, lineClass = 'terminal-output') => {
      const line = document.createElement('p');
      line.className = `terminal-line ${lineClass}`;
      line.textContent = text;
      log.appendChild(line);
      while (log.children.length > 12) {
        log.firstElementChild?.remove();
      }
      log.scrollTop = log.scrollHeight;
      return line;
    };

    const addStaticCommand = (command) => {
      const line = document.createElement('p');
      line.className = 'terminal-line terminal-command';
      line.innerHTML = `<span class="terminal-prompt">${prompt} $</span> <span>${command}</span>`;
      log.appendChild(line);
      return line;
    };

    if (prefersReducedMotion) {
      const firstStep = steps[0];
      if (!firstStep) return;
      addStaticCommand(firstStep.cmd);
      firstStep.output.forEach((line) => addLine(line));
      return;
    }

    const typeCommand = async (command) => {
      const line = document.createElement('p');
      line.className = 'terminal-line terminal-command';
      line.innerHTML =
        `<span class="terminal-prompt">${prompt} $</span> <span class="terminal-typed"></span><span class="terminal-cursor">_</span>`;
      log.appendChild(line);

      const typed = line.querySelector('.terminal-typed');
      if (!(typed instanceof HTMLElement)) return;

      for (const char of command) {
        typed.textContent += char;
        await sleep(18);
      }
      line.querySelector('.terminal-cursor')?.remove();
      log.scrollTop = log.scrollHeight;
    };

    const run = async () => {
      let index = 0;
      while (true) {
        const step = steps[index];
        if (!step) return;

        await typeCommand(step.cmd);
        await sleep(220);
        for (const outputLine of step.output) {
          addLine(outputLine);
          await sleep(420);
        }

        await sleep(1400);
        index = (index + 1) % steps.length;
      }
    };

    run();
  })();
</script>
